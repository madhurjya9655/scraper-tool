<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Scraper Tool</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f1629;
      --panel-2: #121c34;
      --text: #e6eefc;
      --muted: #a6b3cc;
      --line: #223154;
      --accent: #5b8cff;
      --accent-2: #77a1ff;
      --danger: #ff6464;
      --ok: #52d17a;
      --warn: #ffb84d;
      --input-bg: #0d1530;
      --input-border: #2b3a63;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 4px 10px rgba(0,0,0,.25);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b1220 0%, #0a1020 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", Helvetica, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap {
      display: grid;
      grid-template-columns: minmax(16px,1fr) minmax(0,1080px) minmax(16px,1fr);
      padding: 28px 0 48px;
      gap: 24px;
      min-height: 100vh;
    }

    header {
      grid-column: 2;
      margin-bottom: 8px;
    }
    .title {
      margin: 0;
      font-size: 24px;
      letter-spacing: .2px;
    }
    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      grid-column: 2;
      display: grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 18px;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .panel .inner {
      padding: 20px;
    }

    .section-title {
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .help {
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    label {
      display: block;
      margin: 16px 0 6px;
      font-weight: 600;
      font-size: 13px;
    }

    textarea, input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    textarea:focus, input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(91,140,255,.2);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 680px) {
      .row { grid-template-columns: 1fr; }
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-top: 18px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s ease, transform .02s ease;
    }
    .btn:hover { background: var(--accent-2); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
      background: var(--accent);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(13,22,48,.6);
      font-size: 12px;
      color: var(--muted);
    }

    .status {
      display: grid;
      gap: 12px;
      margin-top: 14px;
      font-size: 14px;
    }
    .status .line {
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 24px;
    }
    .tag {
      font-size: 12px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.03);
      white-space: nowrap;
    }

    .downloads {
      display: none;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .downloads a { text-decoration: none; }

    .note {
      background: rgba(255,255,255,.03);
      border: 1px dashed var(--line);
      padding: 12px;
      border-radius: 10px;
      color: var(--muted);
      font-size: 13px;
    }

    .klist {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .klist .k {
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: rgba(255,255,255,.02);
      font-size: 12px;
      color: var(--muted);
    }

    footer {
      grid-column: 2;
      margin-top: 20px;
      padding: 16px 0 8px;
      color: var(--muted);
      font-size: 12px;
      display: flex;
      justify-content: center;
      border-top: 1px solid var(--line);
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="title">Scraper Tool</h1>
      <p class="subtitle">Enter search inputs, run the scraper, and download your results.</p>
    </header>

    <div class="grid">
      <!-- Left: Form -->
      <section class="panel">
        <div class="inner">
          <h2 class="section-title">Inputs</h2>
          <p class="help">Enter comma-separated values. The tool will form keyword × location combinations and scrape company websites (directories/social platforms are filtered out).</p>

          <label for="keywords">Keywords <span class="mono" style="color:var(--muted)">(comma separated)</span></label>
          <textarea id="keywords" rows="3" placeholder="forging company, cnc machining, auto components, vision inspection systems"></textarea>

          <label for="locations">Locations <span class="mono" style="color:var(--muted)">(comma separated)</span></label>
          <textarea id="locations" rows="2" placeholder="Pune, Chennai, Rajkot"></textarea>

          <div class="row">
            <div>
              <label for="industry">Industry <span class="mono" style="color:var(--muted)">(optional)</span></label>
              <input id="industry" placeholder="e.g., Automotive Components"/>
            </div>
            <div>
              <label for="company_type">Company Type <span class="mono" style="color:var(--muted)">(optional)</span></label>
              <input id="company_type" placeholder="e.g., Tier 1 Supplier"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="limit">Per Combo Limit</label>
              <input id="limit" type="number" min="1" max="50" value="12"/>
            </div>
            <div>
              <label for="runtime">Max Runtime (minutes)</label>
              <input id="runtime" type="number" min="1" max="120" value="20"/>
            </div>
          </div>

          <div style="margin-top: 14px;">
            <label for="workers">Workers</label>
            <input id="workers" type="number" min="1" max="64" value="16"/>
          </div>

          <div class="controls">
            <button id="startBtn" class="btn">Start Scraping</button>
            <div id="taskChip" class="chip" style="display:none;"></div>
          </div>

          <div class="status">
            <div class="line">
              <span class="tag">Status</span>
              <span id="progress">Idle.</span>
            </div>

            <div class="downloads" id="downloads">
              <a id="dlCsv"><button class="btn">Download CSV</button></a>
              <a id="dlXlsx"><button class="btn">Download Excel</button></a>
            </div>

            <div class="note">
              Tip: For broader discovery, try multiple adjacent terms (e.g., <span class="mono">"precision machining, hydraulic cylinders, industrial gearboxes"</span>) and several nearby cities.
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Hints -->
      <aside class="panel">
        <div class="inner">
          <h2 class="section-title">Guidance</h2>
          <p class="help">This tool filters directory sites and social networks, prioritizes company domains, extracts emails/phones from typical pages (<span class="mono">/contact</span>, <span class="mono">/about</span>, etc.), and exports per run.</p>

          <h3 class="section-title" style="margin-top:18px;">Sample Keywords</h3>
          <div class="klist">
            <div class="k">steel forging supplier</div>
            <div class="k">precision machined components</div>
            <div class="k">flanges manufacturer</div>
            <div class="k">hydraulic cylinder manufacturer</div>
            <div class="k">industrial gearbox manufacturer</div>
            <div class="k">robotics integrator</div>
            <div class="k">automation systems</div>
            <div class="k">metal fabrication</div>
          </div>

          <h3 class="section-title" style="margin-top:18px;">Good Practices</h3>
          <ul class="help" style="margin: 8px 0 0 18px;">
            <li>Keep keywords concrete; avoid generic words like “best” or “top”.</li>
            <li>Start with a smaller limit, check results, then increase.</li>
            <li>Prefer major cities or industrial clusters for locations.</li>
            <li>If a site blocks requests or has SSL issues, it will be skipped automatically.</li>
          </ul>
        </div>
      </aside>
    </div>

    <footer>
      <div>© 2025 — All rights reserved.</div>
    </footer>
  </div>

<script>
  const startBtn   = document.getElementById('startBtn');
  const progressEl = document.getElementById('progress');
  const downloads  = document.getElementById('downloads');
  const dlCsv      = document.getElementById('dlCsv');
  const dlXlsx     = document.getElementById('dlXlsx');
  const taskChip   = document.getElementById('taskChip');

  let pollTimer = null;

  function parseList(v) {
    return v.split(',')
            .map(s => s.trim())
            .filter(Boolean);
  }

  function numberInRange(v, min, max, fallback) {
    const n = Number(v);
    if (Number.isFinite(n) && n >= min && n <= max) return n;
    return fallback;
    }

  function validateInputs(payload) {
    if (!payload.keywords.length) return "Please enter at least one keyword.";
    if (!payload.locations.length) return "Please enter at least one location.";
    if (payload.limit_per_combo < 1) return "Per Combo Limit must be at least 1.";
    if (payload.max_runtime_min < 1) return "Max Runtime must be at least 1 minute.";
    if (payload.workers < 1) return "Workers must be at least 1.";
    return null;
  }

  async function startScrape() {
    const payload = {
      keywords: parseList(document.getElementById('keywords').value),
      locations: parseList(document.getElementById('locations').value),
      industry: document.getElementById('industry').value.trim(),
      company_type: document.getElementById('company_type').value.trim(),
      limit_per_combo: numberInRange(document.getElementById('limit').value, 1, 50, 12),
      max_runtime_min: numberInRange(document.getElementById('runtime').value, 1, 120, 20),
      workers: numberInRange(document.getElementById('workers').value, 1, 64, 16)
    };

    const err = validateInputs(payload);
    if (err) {
      progressEl.textContent = err;
      return;
    }

    startBtn.disabled = true;
    progressEl.textContent = "Queueing job…";
    downloads.style.display = 'none';
    dlCsv.removeAttribute('href');
    dlXlsx.removeAttribute('href');
    taskChip.style.display = 'none';
    taskChip.textContent = "";

    try {
      const res = await fetch('/start-scrape', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if (!res.ok) throw new Error(json.detail || 'Failed to start');

      const taskId = json.task_id;
      taskChip.style.display = 'inline-flex';
      taskChip.textContent = `Task: ${taskId.slice(0,8)}…`;
      progressEl.textContent = "Queued. Polling status…";

      pollStatus(taskId);
    } catch (e) {
      progressEl.textContent = 'Error: ' + e.message;
      startBtn.disabled = false;
    }
  }

  async function pollStatus(taskId) {
    clearInterval(pollTimer);

    const tick = async () => {
      try {
        const res = await fetch(`/scrape-status/${taskId}`);
        const json = await res.json();
        if (!res.ok) throw new Error(json.detail || 'Status error');

        const phase = json.phase || json.status || "running";
        const prog  = json.progress ? ` (${json.progress})` : '';
        progressEl.textContent = `Status: ${phase}${prog}`;

        if (json.status === 'finished' || json.status === 'completed') {
          const csvUrl  = `/download/csv/${taskId}`;
          const xlsxUrl = `/download/excel/${taskId}`;
          dlCsv.setAttribute('href', csvUrl);
          dlXlsx.setAttribute('href', xlsxUrl);
          downloads.style.display = 'flex';
          startBtn.disabled = false;
          clearInterval(pollTimer);
        }
      } catch (e) {
        progressEl.textContent = 'Status error: ' + e.message;
        startBtn.disabled = false;
        clearInterval(pollTimer);
      }
    };

    await tick();
    pollTimer = setInterval(tick, 3000);
  }

  startBtn.addEventListener('click', startScrape);
</script>
</body>
</html>
